<!DOCTYPE html>
<html>
    <head>
        <title>Deep Guided Filter</title>
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.1/dist/tf.min.js"></script>
        <script>
            $(document).ready(function() {
                document.getElementById('auto_ps').click();

                var slider_r = document.getElementById("r_range");
                var output_r = document.getElementById("r");
                output_r.innerHTML = slider_r.value.padStart(2, '0'); // Display the default slider value

                // Update the current slider value (each time you drag the slider handle)
                slider_r.oninput = function() {
                  output_r.innerHTML = this.value.padStart(2, '0');
                };

                var slider_eps = document.getElementById("eps_range");
                var output_eps = document.getElementById("eps");
                output_eps.innerHTML = '1e'+slider_eps.value.padStart(2, '0'); // Display the default slider value

                // Update the current slider value (each time you drag the slider handle)
                slider_eps.oninput = function() {
                  output_eps.innerHTML = '1e'+this.value.padStart(2, '0');
                }
            });

            var fileReader = new FileReader();
            var image;
            fileReader.onload = function (event) {
                image = new Image();

                image.onload = function(){
                    var canvas = document.createElement("canvas");
                    var context = canvas.getContext("2d");
                    var ratio = Math.min(image.width, image.height) / 64;
                    canvas.width = image.width/ratio;
                    canvas.height = image.height/ratio;
                    context.drawImage(image, 0, 0, image.width, image.height, 0, 0, canvas.width, canvas.height);

                    var form = document.getElementById('upload');
                    var formData = new FormData(form);
                    canvas.toBlob(function(blob) {
                        formData.set('image', blob);
                        $('.loading').attr('hidden', false);
                        $('.input').attr('hidden', true);
                        $('.image').attr('hidden', true);
                        $.ajax({
                            url: 'http://40.121.90.224:8080/upload',
                            type: 'put',
                            data: formData,
                            processData: false,
                            contentType: false
                        }).then(function(data) {
                            $('#path').text(data.data);
                            $('.input').attr('src', image.src).attr('hidden', false);
                            $('.loading').attr('hidden', true);
                        });
                    });
                };
                image.src = event.target.result;
            };

            function upload (input) {
                if (input.files && input.files[0]) {
                    fileReader.readAsDataURL(input.files[0]);
                }
            }

            function click_m(id) {
                $('#'+id).parent().addClass('pure-menu-selected').siblings().removeClass('pure-menu-selected');

                $('#task').text(id);
            }

            function process() {
                $('.loading_process').attr('hidden', false);
                $('.image').attr('hidden', true);
                task = $('#task').text();
                r = parseInt($('#r').text());
                eps = parseFloat($('#eps').text());
                path = $('#path').text();
                $.ajax({
                    url: 'http://40.121.90.224:8080/deep_guided_filter/'+task,
                    data: {'path': path,
                           'r': r, 'eps': eps},
                    type: 'put'
                }).then(function(data) {
                    A = tf.tensor(data.A);
                    b = tf.tensor(data.b);
                    var img = tf.fromPixels(image);
                    A = tf.image.resizeBilinear(A, [image.height, image.width]);
                    b = tf.image.resizeBilinear(b, [image.height, image.width]);
                    img = img.div(255).mul(A).add(b).mul(255).clipByValue(0, 255);
                    if (task === 'style_transfer') {
                        img = img.mean(axis=-1, keepdims=true).tile([1,1,3]);
                    }
                    img = img.pad([[0, 0], [0, 0], [0, 1]], 255);
                    img.data().then(function (data) {
                        var canvas = document.createElement('canvas');
                        ctx = canvas.getContext('2d');
                        canvas.width = image.width;
                        canvas.height = image.height;
                        // create imageData object
                        var idata = ctx.createImageData(image.width, image.height);
                        // set our buffer as source
                        idata.data.set(new Uint8ClampedArray(data));
                        // update canvas with new data
                        ctx.putImageData(idata, 0, 0);
                        $('.image').attr('src', canvas.toDataURL()).attr('hidden', false);
                        $('.loading_process').attr('hidden', true);
                    });
                });
            }
        </script>
    </head>

    <body>
        <h1 align="center">
            Deep Guided Filter
        </h1>
        <div class="pure-menu pure-menu-horizontal" align="center">
            <ul class="pure-menu-list">
                <li class="pure-menu-item"><a href="#ps" class="pure-menu-link" onclick="click_m(this.id)" id="auto_ps">Auto PS</a></li>
                <li class="pure-menu-item"><a href="#l0" class="pure-menu-link" onclick="click_m(this.id)" id="l0_smooth">L<sub>0</sub> Smooth</a></li>
                <li class="pure-menu-item"><a href="#dehaze" class="pure-menu-link" onclick="click_m(this.id)" id="non_local_dehazing">Dehazing</a></li>
                <li class="pure-menu-item"><a href="#scale" class="pure-menu-link" onclick="click_m(this.id)" id="multi_scale_detail_manipulation">Detail Manipulation</a></li>
                <li class="pure-menu-item"><a href="#style" class="pure-menu-link" onclick="click_m(this.id)" id="style_transfer">Style Transfer</a></li>
            </ul>
            <p id="task" hidden></p>
        </div>
        <p>
        <div class="pure-g">
            <div class="pure-u-1-4">
                <div class="slidecontainer;pure-g">
                    <div class="pure-u-1-3" align="right">
                        <label>R: </label>
                        <span id="r"></span>
                    </div>
                    <div class="pure-u-1-3">
                        <input type="range" min="1" max="30" value="1" class="slider" id="r_range">
                    </div>
                </div>
            </div>
            <div class="pure-u-1-4">
                <div class="slidecontainer;pure-g">
                    <div class="pure-u-1-3" align="right">
                        <label>EPS: </label>
                        <span id="eps"></span>
                    </div>
                    <div class="pure-u-1-3">
                        <input type="range" min="-8" max="-1" value="-8" class="slider" id="eps_range">
                    </div>
                </div>
            </div>
            <div class="pure-u-1-4">
                <form id='upload' method="POST" enctype="multipart/form-data">
                    <input type="file" name="image" value="" onchange="upload(this)">
                </form>
                <p id="path" hidden/>
            </div>
            <div class="pure-u-1-4">
                <button class="pure-button" onclick="process()">Process</button>
            </div>
        </div>
        <p/>
        <div class="pure-g">
            <div class="pure-u-1-2" align="center">
                <img src='' class='input' hidden width="90%"/>
                <img src='load.gif' class='loading' hidden width="10%"/>
            </div>
            <div class="pure-u-1-2" align="center">
                <img src='' class='image' hidden width="90%"/>
                <img src='load.gif' class='loading_process' hidden width="10%"/>
            </div>
        </div>

    </body>
</html>
